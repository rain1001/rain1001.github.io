---
title: SNMP简介
author: Rain Lee
date: 2021-3-16 20:00:00 +0800
categories: [网络, 协议]
tags: [snmp]
math: true
---

# 1. 基于SNMP的网络管理

基于SNMP的网络管理结构主要分为4个组成部分：

- 网络管理站NMS（Network Management Station）

  NMS通常是一个独立的设备，运行网络管理应用程序。网络管理应用程序至少能够提供一个人机交互界面，网络管理员通过它完成绝大多数网络管理工作。

- SNMP代理器（Agent）

  Agent是驻留在被管理设备的一个软件模块，主要负责接收和处理来自NMS的请求报文，并形成响应报文，返回给NMS；在一些紧急情况下，它会主动发送trap报文，通知NMS。一般是交换机等设备上的一个进程。

- SNMP协议

  SNMP协议属于TCP/IP网络的应用层协议，用于在NMS和被管理设备间交互管理信息。

- 管理信息库MIB（Management Information Base）

  MIB是一个被管理对象的集合，是NMS同Agent进行沟通的桥梁，可以使网管软件和设备进行标准对接。每一个Agent都维护这样一个MIB库，NMS可以对MIB库中对象的值进行读取或设置。

![img](/assets/img/202012/zh-cn_image_0141129978.png)

它们之间的通信方式描述如下：

- NMS通过SNMP协议与设备的Agent通信，完成对MIB的读取和修改操作，从而实现对网络设备的监控与管理。
- SNMP是NMS与Agent之间通信的载体，通过其协议数据单元PDU（Protocol Data Unit）完成信息交换。SNMP并不负责数据的实际传输，数据交换的任务是通过UDP等传输层协议来完成的。
- Agent是设备上的代理进程，主要工作包括与NMS通信，对设备中的MIB库进行维护，以管理和监控设备中的各个模块。
- MIB保存设备中各个模块的信息。通过对MIB信息的读写操作来完成对设备的监控和维护。

# 2. SNMP版本

SNMP协议的版本包括：SNMPv1、SNMPv2c、SNMPv3。

SNMPv1和SNMPv2c都是使用基于团体名的认证。NMS通过团体名列表控制对设备的访问权限，而代理（Agent）并不核实发送者是否使用了授权的团体名，同时，SNMP消息未采用加密传输，因此在认证和私有性方面缺乏安全保障。

SNMPv2c在SNMPv1的基础上进行了增强，增强的功能包括：支持更多的操作、支持更多的数据类型、提供更丰富的错误处理码和多种传输协议的支持。

SNMPv3定义了包含SNMPv1、SNMPv2所有功能在内的体系框架和包含验证服务和加密服务在内的全新安全机制。

SNMPv3的安全性主要体现在数据安全和访问控制上。

SNMPv3提供消息级的数据安全，它包括以下三种情况：

- 数据完整性：数据不会在未被授权方式下修改，数据顺序的改动也不会超出许可范围。
- 数据来源验证：确认所收到的数据来自哪个用户。SNMPv3定义的安全性是基于用户的，它验证的是生成消息的用户，而不是具体生成消息的应用程序。
- 数据核实性检查：当NMS或Agent接收到消息时，对消息的生成时间进行检查，如果消息时间与系统当前时间的差超出了指定的时间范围，该消息就不被接受。这可以防止消息在网络传输过程中被恶意更改，或收到并处理恶意发送的消息。

SNMPv3的访问控制是基于协议操作的安全性检查，控制对被管理对象的访问。

# 3. SNMP报文

SNMP规定了5种协议数据单元PDU（也就是SNMP报文），用于NMS与Agent的交互。

各种报文的操作如下：

- get-request：从代理进程处提取一个或多个参数值。
- get-next-request：从代理进程处提取紧跟当前参数值的下一个参数值。
- set-request：设置代理进程的一个或多个参数值。
- get-response：返回的一个或多个参数值。这个操作是由代理进程发出的，它是对前面3种操作的响应。
- trap：代理进程主动发出的报文，通知管理进程有某些事件发生。它的功能就是在网络管理系统没有明确要求的前提下，由管理代理通知网络管理系统有一些特别的情况或问题 发生了。如果发生意外情况，客户会向服务器的162端口发送一个消息，告知服务器指定的变量值发生了变化。通常由服务器请求而获得的数据由服务器的161 端口接收。Trap 消息可以用来通知管理站线路的故障、连接的终端和恢复、认证失败等消息。管理站可相应的作出处理。

前面3种操作由NMS向Agent发出，后面2种操作由Agent向NMS发出。

SNMP协议定义了数据包的格式，及网络管理员和管理代理之间的信息交换，它还控制着管理代理的MIB数据对象。因此，可用于处理管理代理定义的各种任务。
  一条SNMP消息由"版本号"、"SNMP共同体名"和"协议数据单元(PDU)"构成，数据包的长度不是固定的。

![img](/assets/img/202012/810EB22E-5F4F-4111-BFE6-E170CBDBDE1F.png)

- **版本识别符(version identifier)**：用于说明现在使用的是哪个版本的SNMP协议，确保SNMP代理使用相同的协议，每个SNMP代理都直接抛弃与自己协议版本不同的数据报。
- **团体名(Community Name)**：**团体（community）是基本的安全机制，用于实现SNMP网络管理员访问SNMP管理代理时的身份验证。类似于密码，默认值为 public。团体名（Community name）是管理代理的口令，管理员被允许访问数据对象的前提就是网络管理员知道网络代理的口令。**如果把配置管理代理成可以执行Trap命令，当网络管理 员用一个错误的分区名查询管理代理时，系统就发送一个autenticationFailure trap报文。
- **协议数据单元（PDU）**：**PDU** (协议数据单元)是SNMP消息中的数据区， 即Snmp通信时报文数据的载体。PDU指明了SNMP的消息类型及其相关参数

# 4. SNMP报文处理过程

Agent通过UDP端口**161**接收来自NMS的Request报文，162口接收trap，执行SNMP的设备缺省必须采用这些端口。

![img](/assets/img/202012/zh-cn_image_0141129984.png)

Agent接收到报文后，其基本处理过程如下：

1. 解码：依据ASN.1基本编码规则，生成用内部数据结构表示的报文。如果此过程出现错误导致解码失败，则丢弃该报文，不做进一步处理。
2. 比较SNMP版本号：将报文中的版本号取出，与本Agent支持的SNMP版本号比较。如果不一致，则丢弃该报文，不做进一步处理。
3. 团体名验证：将报文中的团体名取出，此团体名由发出请求的网管站填写。如与Agent所在设备认可的团体名不符，则丢弃该报文，不做进一步处理，同时产生一个Trap报文。SNMPv1提供较弱的安全措施，在版本3中这一功能被加强。
4. 提取PDU：从通过验证的ASN.1对象中提出协议数据单元PDU。如果失败，丢弃报文，不做进一步处理。
5. 处理PDU：根据不同的PDU，SNMP协议实体进行不同的处理。得到管理变量在MIB树中对应的节点，从相应的模块中得到管理变量的值，形成Response报文，编码发回网管站。
6. 网管站得到响应报文后，经过同样的处理，最终显示结果。

# 5. MIB介绍

介绍了MIB的作用、存储和引用方式、MIB的分类以及如何加载MIB。

MIB是一个被管理对象的集合，它定义被管理对象的一系列属性，包括

- 对象的名字
- 对象的访问权限
- 对象的数据类型

管理信息结构SMI（Structure of Management Information）规定了被管理的对象应该如何定义和组织，它定义了一系列MIB可以使用的数据类型，比如Counter、Gauge等。

MIB指明了网络元素所维护的变量，即能够被NMS查询和设置的信息，给出了一个网络中所有可能的被管理对象的集合的数据结构。

## 5.1 MIB树

MIB以树状结构进行存储，树的叶子节点表示管理对象，它可以通过从根节点开始的一条惟一路径来识别，这也就是OID（Object Identifier）。
![img](/assets/img/202012/zh-cn_image_0141129990.png)

OID是由一些系列非负整数组成，用于唯一标识管理对象在MIB树中的位置。由SMI来保证OID不会冲突。

MIB文件一旦发布，OID就和被定义的对象绑定，不能修改。MIB节点不能被删除，只能将它的状态置为“obsolete”，表明该节点已经被废除。

在图中的树形结构中，mgmt对象可以标识为：1.3.6.1.2，这种标识就叫做OID。

NMS通过OID引用Agent中的对象。